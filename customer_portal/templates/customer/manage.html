<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manage Rentals</title>
</head>
<body>

{% load static %}
{% block content %}

<style>
  html, body {
    margin: 0; padding: 0; font-family: 'Poppins', sans-serif; height: 100%;
    background: linear-gradient(to right, rgba(40, 62, 81, 0.7), rgba(72, 85, 99, 0.7)),
      url("{% static 'images/rental.png' %}") no-repeat center center fixed;
    background-size: cover; color: #fff;
  }
  body { display: flex; flex-direction: column; min-height: 100vh; }

  @keyframes floatIn {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }

  nav, .orders-section, footer { animation: floatIn 0.8s ease-out; }

  nav {
    display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
    padding: 18px 40px; background: rgba(255,255,255,0.06); backdrop-filter: blur(6px);
    border-bottom: 1px solid rgba(255,255,255,0.08);
  }
  nav .logo { height: 68px; }
  nav h1 { margin: 0; text-align: center; font-size: 22px; font-weight: 600; }
  nav .links { display: flex; gap: 20px; justify-content: flex-end; }
  nav .links a { color: #fff; text-decoration: none; font-weight: 500; }
  nav .links a:hover { color: #a8e0ff; }

  .orders-section { flex: 1; display: flex; flex-direction: column; align-items: center; padding: 20px 10px 50px 10px; }
  .orders-section h3 { font-size: 26px; font-weight: 700; margin-bottom: 20px; }

  table {
    border-collapse: collapse; width: 98%; max-width: 1300px;
    background: rgba(255, 255, 255, 0.9); color: #333; border-radius: 12px;
    overflow: hidden; box-shadow: 0 6px 18px rgba(0, 0, 0, 0.25);
  }
  th, td { padding: 12px 10px; text-align: center; font-size: 14px; border-bottom: 1px solid #ddd; }
  th { background-color: #283e51; color: #fff; font-weight: 600; text-transform: uppercase; font-size: 11px; }
  tr:hover { background-color: rgba(240, 240, 240, 0.9); }

  .date-badge {
    padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold;
    display: block; margin: 4px 0; text-align: left;
  }

  .dest-text { font-style: italic; color: #2563eb; font-weight: 600; max-width: 150px; word-wrap: break-word; }

  .btn-delete { background-color: #e11d48; border: none; padding: 6px 12px; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; }
  .btn-delete:hover { background-color: #b91c1c; transform: scale(1.05); }
  .btn-return { background-color: #16a34a; border: none; padding: 6px 12px; border-radius: 6px; color: white; font-weight: 600; cursor: pointer; transition: 0.3s; }
  .btn-return:hover { background-color: #15803d; transform: scale(1.05); }

  .status-on-time { color: #2563eb; font-weight: bold; }
  .status-warning { color: #ea580c; font-weight: bold; }
  .status-overdue { color: #e11d48; font-weight: bold; }
  .checked-status { color: #16a34a; font-weight: 800; font-size: 14px; }
  
  .penalty-box { font-size: 11px; background: #fee2e2; color: #b91c1c; padding: 4px; border-radius: 4px; margin-top: 5px; border: 1px solid #fecaca; }

  /* Modals Base */
  #returnModal, #customConfirmModal, #statusModal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
  .modal-content { background-color: #fff; margin: 10% auto; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; color: #333; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

  footer { text-align: center; padding: 18px; color: #ccc; font-size: 14px; }
</style>

<nav>
  <div><img src="{% static 'images/logo.png' %}" alt="Logo" class="logo"></div>
  <div><h1>Online Car Rental System</h1></div>
  <div class="links">
    <a href="/customer_portal/home/">Home</a>
    <a href="/customer_portal/search/">Search</a>
    <a href="/customer_portal/logout/">Logout</a>
  </div>
</nav>

<section class="orders-section">
  <h3>Your Rental Management</h3>
  <table>
    <thead>
      <tr>
        <th>Car Model</th>
        <th>Schedule</th>
        <th>Remaining Days</th>
        <th>Total Rent</th>
        <th>Capacity</th>
        <th>Vehicle Info</th>
        <th>Destination</th>
        <th>Pincode</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for order in od %}
      <tr>
        <td style="font-weight:bold;">{{ order.vehicle.car_name }}</td>
        <td>
          <span class="date-badge" style="border-left: 4px solid #16a34a; background: #eefdf3; color: #2d3748;">
            Pick-up: {{ order.rental_date|default:"N/A" }}
          </span>
          <span class="date-badge" style="border-left: 4px solid #e11d48; background:#fff5f5; color: #2d3748;">
            Return: {{ order.return_date|default:"N/A" }}
          </span>
        </td>

        <td>
            {% if order.remaining_days > 0 %}
                <span class="status-on-time">{{ order.remaining_days }} Days{% if not order.is_complete %} left{% endif %}</span>
            {% elif order.remaining_days == 0 %}
                {% if not order.is_complete %}<span class="status-warning">Return Today!</span>{% else %}<span style="color: #666; font-weight: bold;">0 Days</span>{% endif %}
            {% else %}
                <span class="status-overdue">OVERDUE</span>
                {% if not order.is_complete %}<div class="penalty-box">Penalty: ₱{{ order.penalty }}</div>{% else %}<div style="color: #666; font-size: 11px; font-weight: bold;">(Settled)</div>{% endif %}
            {% endif %}
        </td>

        <td style="font-weight:bold;">
          {% if order.dest == "CANCELLED_ORDER" %}
              <span style="color:#e11d48; text-decoration: line-through;">₱{{ order.rent }}</span>
          {% else %}
              <span style="color:#16a34a;">₱{{ order.rent }}</span>
          {% endif %}
        </td>

        <td>{{ order.vehicle.capacity }} Seats</td>
        <td style="font-size:12px; color:#666;">{{ order.vehicle.description }}</td>
        <td class="dest-text">{{ order.dest|default:"" }}</td>
        <td>{{ order.vehicle.area.pincode }}</td>

        <td>
          {% if not order.is_complete %}
              {% if order.is_pending %}
                  <span style="color: #ea580c; font-weight: bold; font-size: 14px;">⏳ PENDING</span>
              {% else %}
                  <div style="display:flex; gap:5px; justify-content: center;">
                      <form action="/customer_portal/cancel_order/" method="post" id="cancelForm{{order.id}}">
                          {% csrf_token %}
                          <input type="hidden" name="id" value="{{ order.id }}">
                          <button type="button" class="btn-delete" onclick="askConfirm('cancel', '{{order.id}}')">Cancel</button>
                      </form>
                      <button type="button" class="btn-return" onclick="openReturnModal('{{order.id}}', '{{order.vehicle.car_name}}', '{{order.rental_date}}', '{{order.return_date}}', '{{order.rent}}')">Return</button>
                  </div>
              {% endif %}
          {% else %}
              {% if order.dest == "CANCELLED_ORDER" %}
                  <span style="color:#e11d48; font-weight:bold;">✔ Cancelled</span>
              {% else %}
                  <span class="checked-status">✔ Returned</span>
              {% endif %}
          {% endif %}
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="9" style="padding: 40px; color: #888;">No active rentals found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</section>

<div id="returnModal">
    <div class="modal-content">
      <h4 style="margin-top:0; color:#283e51;">Return Vehicle Form</h4>
      <hr>
      <div style="font-size: 13px; line-height: 1.6; margin-bottom: 15px;">
          <strong>Car Model:</strong> <span id="m_car"></span><br>
          <strong>Schedule:</strong> <span id="m_sched"></span><br>
          <strong>Total Rent:</strong> <span id="m_rent" style="color:#16a34a; font-weight:bold;"></span>
      </div>
      
      <form action="/customer_portal/return_order/" method="post" id="actualReturnForm">
          {% csrf_token %}
          <input type="hidden" name="id" id="m_order_id">
          <label style="font-size:12px; font-weight:600;">Condition of Vehicle / Feedback:</label>
          <textarea name="feedback" style="width:100%; height:60px; margin-top:5px; border-radius:5px; border:1px solid #ccc; padding:8px; box-sizing: border-box;" placeholder="Is the car okay?"></textarea>
          
          <div style="margin-top:20px; display:flex; gap:10px;">
              <button type="button" class="btn-return" style="flex:1;" onclick="askConfirm('return')">Confirm Return</button>
              <button type="button" style="flex:1; background:#94a3b8; border:none; border-radius:6px; color:white; cursor:pointer; font-weight:600;" onclick="closeModal()">Close</button>
          </div>
      </form>
    </div>
</div>

<div id="customConfirmModal">
    <div class="modal-content" style="text-align: center;">
        <h4 id="confirmTitle" style="margin-top:0; color:#283e51;">Confirmation</h4>
        <p id="confirmText" style="font-size: 14px; color: #555;"></p>
        <div style="margin-top:25px; display:flex; gap:10px;">
            <button id="confirmYesBtn" class="btn-return" style="flex:1;">Yes</button>
            <button id="confirmNoBtn" style="flex:1; background:#94a3b8; border:none; border-radius:6px; color:white; cursor:pointer; font-weight:600;">No</button>
        </div>
    </div>
</div>

<div id="statusModal">
    <div class="modal-content" style="text-align: center;">
        <div id="statusIcon" style="font-size: 40px; margin-bottom: 10px;"></div>
        <h4 id="statusTitle" style="margin-top:0;"></h4>
        <p id="statusText" style="font-size: 14px; color: #555;"></p>
        <button id="statusOkBtn" class="btn-return" style="width: 100%; margin-top: 20px; display: none;">OK</button>
    </div>
</div>

<script>
    let currentAction = "";
    let currentId = "";

    function showStatus(type, title, message, callback) {
        const modal = document.getElementById('statusModal');
        const icon = document.getElementById('statusIcon');
        const tit = document.getElementById('statusTitle');
        const txt = document.getElementById('statusText');
        const btn = document.getElementById('statusOkBtn');

        tit.innerText = title;
        txt.innerText = message;
        
        if(type === 'success') {
            icon.innerText = "✔️";
            tit.style.color = "#16a34a";
            // Auto close success after 1.5s then callback
            modal.style.display = 'block';
            setTimeout(() => {
                modal.style.display = 'none';
                if(callback) callback();
            }, 1500);
        } else {
            icon.innerText = "ℹ️";
            tit.style.color = "#283e51";
            btn.style.display = "block";
            modal.style.display = 'block';
            btn.onclick = function() {
                modal.style.display = 'none';
                btn.style.display = "none";
            };
        }
    }

    function askConfirm(action, id = "") {
        currentAction = action;
        currentId = id;
        const modal = document.getElementById('customConfirmModal');
        const text = document.getElementById('confirmText');
        
        text.innerText = (action === 'cancel') ? "Do you want to Cancel your Rental?" : "Do you want to Return this vehicle?";
        modal.style.display = 'block';
    }

    document.getElementById('confirmNoBtn').onclick = function() {
        document.getElementById('customConfirmModal').style.display = 'none';
        showStatus('info', 'Cancelled', 'Standby to steel');
    };

    document.getElementById('confirmYesBtn').onclick = function() {
        document.getElementById('customConfirmModal').style.display = 'none';
        
        if(currentAction === 'cancel') {
            showStatus('success', 'Success', 'Successfully Cancelled', () => {
                document.getElementById('cancelForm' + currentId).submit();
            });
        } else {
            showStatus('success', 'Success', 'Successfully Returned', () => {
                document.getElementById('actualReturnForm').submit();
            });
        }
    };

    function openReturnModal(id, car, p, r, rent) {
        document.getElementById('m_order_id').value = id;
        document.getElementById('m_car').innerText = car;
        document.getElementById('m_sched').innerText = p + " to " + r;
        document.getElementById('m_rent').innerText = "₱" + rent;
        document.getElementById('returnModal').style.display = 'block';
    }

    function closeModal() {
        document.getElementById('returnModal').style.display = 'none';
    }
</script>

<footer>&copy; 2026 All Rights Reserved. Owned by CJ Archivido</footer>
{% endblock %}
</body>
</html>

<!--Start of Tawk.to Script-->
<script type="text/javascript">
var Tawk_API=Tawk_API||{}, Tawk_LoadStart=new Date();
(function(){
var s1=document.createElement("script"),s0=document.getElementsByTagName("script")[0];
s1.async=true;
s1.src='https://embed.tawk.to/697cd26dc28f7e1c39908c99/1jg7pbv4a';
s1.charset='UTF-8';
s1.setAttribute('crossorigin','*');
s0.parentNode.insertBefore(s1,s0);
})();
</script>
<!--End of Tawk.to Script-->